@inherits Fluxor.Blazor.Web.Components.FluxorComponent

<MudCard Class="rounded mb-3 mx-3" Elevation="3" Outlined="true">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText>Instrument @Instrument</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudSelect ValueChanged="HandleMinNoteChange" Value="MinNote" Label="Minimum Note" T="Note">
                    @foreach (var note in GetNotes())
                    {
                        <MudSelectItem Value="note">@note</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSelect ValueChanged="HandleMaxNoteChange" Value="MaxNote" Label="Maximum Note" T="Note">
                    @foreach (var note in GetNotes())
                    {
                        <MudSelectItem Value="note">@note</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSelect ValueChanged="HandleMidiInstrumentChange" Value="MidiInstrument" Label="MidiProgram" T="GeneralMidi2Program">
                    @foreach (var instrument in EnumUtils<GeneralMidi2Program>.AsEnumerable())
                    {
                        <MudSelectItem Value="instrument">@instrument</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSwitch Value="IsEnabled" ValueChanged="HandleIsEnabledChange" Label="Enabled" T="bool" Color="Color.Primary"/>
            </MudItem>
        </MudGrid>
    </MudCardContent>
</MudCard>

@code
{
    [Parameter, EditorRequired] public Instrument Instrument { get; set; }

    private Note MinNote => InstrumentConfigurationState.Value[Instrument]?.MinNote ?? Notes.C3;

    private Note MaxNote => InstrumentConfigurationState.Value[Instrument]?.MaxNote ?? Notes.C6;

    private GeneralMidi2Program MidiInstrument => InstrumentConfigurationState.Value[Instrument]?.MidiProgram ?? GeneralMidi2Program.AcousticGrandPiano;

    private bool IsEnabled => InstrumentConfigurationState.Value[Instrument]?.IsEnabled ?? false;

    private static IEnumerable<Note> GetNotes() => Enumerable.Range(0, 127).Select(noteNumber => Note.Get((SevenBitNumber)noteNumber));

    private void HandleMinNoteChange(Note note) => Dispatcher.Dispatch(new UpdateInstrumentConfiguration(Instrument, note, MaxNote, MidiInstrument, IsEnabled));

    private void HandleMaxNoteChange(Note note) => Dispatcher.Dispatch(new UpdateInstrumentConfiguration(Instrument, MinNote, note, MidiInstrument, IsEnabled));

    private void HandleMidiInstrumentChange(GeneralMidi2Program instrument) => Dispatcher.Dispatch(new UpdateInstrumentConfiguration(Instrument, MinNote, MaxNote, instrument, IsEnabled));

    private void HandleIsEnabledChange(bool isEnabled) => Dispatcher.Dispatch(new UpdateInstrumentConfiguration(Instrument, MinNote, MaxNote, MidiInstrument, isEnabled));
}
